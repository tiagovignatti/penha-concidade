<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PUBLICAÇÕES EIV/RIV - CONCIDADE Penha/SC</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
:root {
  --bg: #f5f5f5;
  --card-bg: #fff;
  --text: #1a1a2e;
  --text-secondary: #555;
  --accent: #2563eb;
  --accent-light: #dbeafe;
  --border: #e5e7eb;
  --green: #16a34a;
  --orange: #ea580c;
  --red: #dc2626;
  --radius: 10px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
}
#main-content { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }

/* Header */
.header {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
  gap: 16px;
}
.header h1 { font-size: 1.5rem; color: var(--text); }
.header .subtitle { font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px; }
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}
.section-header .section-title { margin-bottom: 0; }
.section-export button {
  padding: 4px 10px;
  border: 1px solid var(--border);
  border-radius: 5px;
  background: var(--card-bg);
  cursor: pointer;
  font-size: 0.72rem;
  color: var(--text-secondary);
  transition: background 0.2s;
}
.section-export button:hover { background: var(--accent-light); color: var(--accent); }

/* Summary Cards */
.summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
  margin-bottom: 32px;
}
.stat-card {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 16px;
  text-align: center;
  border: 1px solid var(--border);
}
.stat-card .number { font-size: 1.8rem; font-weight: 700; color: var(--red); }
.stat-card .label { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }

/* Chart Section */
.section-title {
  font-size: 1.15rem;
  font-weight: 600;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--accent);
  display: inline-block;
}
.chart-section { margin-bottom: 40px; }
.chart-toggles {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 16px;
}
.chart-toggles button {
  padding: 6px 14px;
  border: 1px solid var(--border);
  border-radius: 20px;
  background: var(--card-bg);
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.2s;
}
.chart-toggles button.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}
.chart-container {
  background: var(--card-bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 16px;
  position: relative;
  height: 420px;
}

/* Skyline */
.skyline-section { margin-bottom: 40px; }
.skyline {
  display: flex;
  align-items: flex-end;
  gap: 4px;
  background: var(--card-bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 24px 16px 16px;
  min-height: 300px;
  overflow-x: auto;
}
.skyline-bar {
  flex: 1;
  min-width: 50px;
  max-width: 120px;
  border-radius: 4px 4px 0 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  padding: 6px 2px;
  cursor: default;
  transition: opacity 0.2s;
  position: relative;
}
.skyline-bar:hover { opacity: 0.85; }
.skyline-bar .floors {
  font-size: 0.7rem;
  font-weight: 700;
  color: #fff;
  writing-mode: horizontal-tb;
  margin-bottom: 4px;
}
.skyline-bar .name {
  font-size: 0.6rem;
  color: var(--text-secondary);
  text-align: center;
  margin-top: 6px;
  line-height: 1.2;
  max-width: 100%;
  overflow: hidden;
  word-break: break-word;
}

/* Project Cards */
.cards-section { margin-bottom: 40px; }
.filter-sort {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
  align-items: center;
}
.filter-sort select, .filter-sort input {
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 0.85rem;
  background: var(--card-bg);
}
.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 16px;
}
.project-card {
  background: var(--card-bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 20px;
  transition: box-shadow 0.2s;
}
.project-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
.project-card .card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
  gap: 8px;
}
.project-card .card-title {
  font-size: 1rem;
  font-weight: 600;
  line-height: 1.3;
}
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 600;
  white-space: nowrap;
}
.badge-residencial { background: #dbeafe; color: #1d4ed8; }
.badge-hotel { background: #fef3c7; color: #92400e; }
.badge-logistico { background: #d1fae5; color: #065f46; }
.badge-certidao { background: #fce7f3; color: #9d174d; }
.card-company { font-size: 0.82rem; color: var(--text-secondary); margin-bottom: 8px; }
.card-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
  margin-bottom: 12px;
}
.card-stat {
  font-size: 0.78rem;
  color: var(--text-secondary);
}
.card-stat strong { color: var(--text); }
.card-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}
.tag {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  background: #f3f4f6;
  color: var(--text-secondary);
}
.tag-bairro { background: #ede9fe; color: #5b21b6; }
.tag-approved { background: #d1fae5; color: var(--green); }
.tag-pending { background: #fef3c7; color: var(--orange); }

/* Timeline */
.timeline-section { margin-bottom: 40px; }
.timeline-container {
  background: var(--card-bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 20px;
  position: relative;
}
.timeline-labels {
  position: sticky;
  left: 0;
  z-index: 2;
  background: var(--card-bg);
  float: left;
  width: 170px;
}
.timeline-labels .timeline-label-row {
  padding: 8px 8px 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.78rem;
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  height: 44px;
  display: flex;
  align-items: center;
}
.timeline-labels .timeline-label-row:last-child { border-bottom: none; }
.timeline-labels .eiv-link:hover { color: var(--accent); }
.timeline-tracks-wrapper {
  margin-left: 170px;
  overflow-x: auto;
}
.timeline-tracks {
  min-width: 500px;
  transition: min-width 0.3s ease;
}
.timeline-tracks.expanded {
  min-width: 2400px;
}
.timeline-track-row {
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  height: 44px;
  display: flex;
  align-items: center;
}
.timeline-track-row:last-child { border-bottom: none; }
.timeline-track {
  flex: 1;
  position: relative;
  height: 28px;
  display: flex;
  align-items: center;
}
.timeline-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  position: absolute;
  cursor: pointer;
  z-index: 1;
  transition: all 0.25s ease;
  transform: translateX(-5px);
}
.timeline-dot .dot-label {
  display: none;
  font-size: 0.68rem;
  font-weight: 600;
  color: #fff;
  white-space: nowrap;
  line-height: 1;
}
.timeline-dot.expanded {
  height: 20px;
  border-radius: 10px;
  width: auto;
  padding: 0 6px;
  display: flex;
  align-items: center;
  z-index: 3;
  transform: translateX(-5px) translateY(-5px);
}
.timeline-dot.expanded .dot-label { display: inline; }
.timeline-dot.protocolo { background: #8b5cf6; }
.timeline-dot.audiencia { background: var(--accent); }
.timeline-dot.reuniao { background: var(--orange); }
.timeline-dot.parecer { background: var(--green); }
.timeline-line {
  position: absolute;
  height: 2px;
  background: var(--border);
  top: 50%;
  transform: translateY(-50%);
}
.timeline-legend {
  display: flex;
  gap: 16px;
  margin-bottom: 12px;
  font-size: 0.78rem;
  color: var(--text-secondary);
}
.timeline-legend span::before {
  content: '';
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 4px;
  vertical-align: middle;
}
.legend-protocolo::before { background: #8b5cf6; }
.legend-audiencia::before { background: var(--accent); }
.legend-reuniao::before { background: var(--orange); }
.legend-parecer::before { background: var(--green); }

/* Footer */
.footer {
  text-align: center;
  padding: 24px 0;
  font-size: 0.78rem;
  color: var(--text-secondary);
  border-top: 1px solid var(--border);
}
.footer a { color: var(--accent); text-decoration: none; }

/* Tooltip */
.tooltip {
  position: absolute;
  background: rgba(0,0,0,0.85);
  color: #fff;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 0.75rem;
  pointer-events: none;
  white-space: nowrap;
  z-index: 100;
  display: none;
}

@media (max-width: 600px) {
  .header h1 { font-size: 1.2rem; }
  .summary { grid-template-columns: repeat(2, 1fr); }
  .cards-grid { grid-template-columns: 1fr; }
  .chart-container { height: 350px; }
}
</style>
</head>
<body>

<div id="main-content">
  <!-- Header -->
  <div class="header">
    <div>
      <h1>PUBLICAÇÕES EIV/RIV - CONCIDADE Penha/SC</h1>
      <div class="subtitle">Dados extraídos dos Relatórios de Impacto de Vizinhança publicados pelo Conselho Municipal da Cidade</div>
    </div>
  </div>

  <!-- Summary -->
  <div class="summary" id="summary"></div>

  <!-- Timeline -->
  <div class="timeline-section" id="sec-timeline">
    <div class="section-header"><div class="section-title">Linha do Tempo</div><div class="section-export"><button onclick="exportSection('sec-timeline')">PNG</button></div></div>
    <div class="timeline-legend">
      <span class="legend-protocolo">Requerimento</span>
      <span class="legend-audiencia">Audiência Pública</span>
      <span class="legend-reuniao">Plenária</span>
      <span class="legend-parecer">Deliberação</span>
    </div>
    <div class="timeline-container" id="timeline"></div>
  </div>

  <!-- Skyline -->
  <div class="skyline-section" id="sec-skyline">
    <div class="section-header"><div class="section-title">Pavimentos</div><div class="section-export"><button onclick="exportSection('sec-skyline')">PNG</button></div></div>
    <div class="skyline" id="skyline"></div>
  </div>

  <!-- Project Cards -->
  <div class="cards-section" id="sec-cards">
    <div class="section-header"><div class="section-title">Projetos</div><div class="section-export"><button onclick="exportSection('sec-cards')">PNG</button></div></div>
    <div class="filter-sort">
      <select id="filterBairro"><option value="">Todos os bairros</option></select>
      <select id="sortBy">
        <option value="data_protocolo">Ordenar: Requerimento</option>
        <option value="pavimentos">Ordenar: Pavimentos</option>
        <option value="area_construida_m2">Ordenar: Área Construída</option>
        <option value="unid_total">Ordenar: Total Unidades</option>
        <option value="vagas_estacionamento">Ordenar: Vagas</option>
      </select>
    </div>
    <div class="cards-grid" id="cards-grid"></div>
  </div>

  <!-- Chart -->
  <div class="chart-section" id="sec-chart">
    <div class="section-header"><div class="section-title">Gráfico Comparativo</div><div class="section-export"><button onclick="exportSection('sec-chart')">PNG</button></div></div>
    <div class="chart-toggles" id="chart-toggles"></div>
    <div class="chart-container">
      <canvas id="barChart"></canvas>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    Fonte: <a href="https://penha.atende.net/subportal/conselho-municipal-concidade" target="_blank">Portal CONCIDADE — Prefeitura de Penha/SC</a>
    &nbsp;|&nbsp; Gerado em <span id="gen-date"></span>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
// ----- Data -----
let DATA = [];

// Bairro color map
const BAIRRO_COLORS = {
  'Centro': '#2563eb',
  'Praia de Armação do Itapocoroi': '#7c3aed',
  'Praia de Armação do Itapocoroy': '#7c3aed',
  'Praia de Armação': '#7c3aed',
  'Praia Alegre / Centro': '#0891b2',
  'São Cristovão': '#059669',
  'Santa Lídia': '#d97706',
  'Nossa Senhora de Fátima': '#dc2626',
};

function bairroColor(b) {
  if (!b) return '#94a3b8';
  // Normalize Armação variants
  if (b.includes('Armação')) return '#7c3aed';
  return BAIRRO_COLORS[b] || '#94a3b8';
}

function normalizeBairro(b) {
  if (!b) return 'Sem bairro';
  if (b.includes('Armação')) return 'Praia de Armação';
  return b;
}

function buildingName(p) {
  const emp = p.empreendimento || '';
  if (emp.includes('SEVEN')) return 'Seven Residence';
  if (emp.includes('PARKSIDE')) return 'Parkside';
  if (emp.includes('ACQUA')) return 'Acqua Ocean View';
  if (emp.includes('BLANC')) return 'Residencial Blanc';
  if (emp.includes('VISION')) return 'Residencial Vision';
  if (emp.includes('HOTEL') && p.id === 8) return 'California Hotel';
  if (emp.includes('TERMINAL') || emp.includes('LOGÍSTICO')) return 'Centro Logístico';
  if (emp.includes('Transbordo')) return 'Est. Transbordo';
  if (p.requerente) {
    const r = p.requerente;
    if (r.includes('RÔGGA') || r.includes('ROGGA')) return 'Tropicale';
    if (r.includes('RT 49') || r.includes('RT49')) return 'RT 49';
    if (r.includes('VETTER')) return 'Fort Myers';
    if (r.includes('1 SPE') || r.includes('1SPE')) return 'Halsten';
  }
  return emp.substring(0, 25) || `Projeto ${p.id}`;
}

function shortName(p) {
  const name = buildingName(p);
  const emp = p.empreendimento || '';
  const r = p.requerente || '';
  // Add company in parentheses
  if (emp.includes('SEVEN')) return name + ' (Mapesul)';
  if (emp.includes('PARKSIDE')) return name + ' (Parkside SPE)';
  if (emp.includes('ACQUA')) return name + ' (G10)';
  if (emp.includes('BLANC')) return name + ' (Engeoffice)';
  if (emp.includes('VISION')) return name + ' (Engeoffice)';
  if (emp.includes('HOTEL') && p.id === 8) return name + ' (Casa Prime)';
  if (emp.includes('TERMINAL') || emp.includes('LOGÍSTICO')) return name + ' (HR Aluguel)';
  if (r.includes('RÔGGA') || r.includes('ROGGA')) return name + ' (Rôgga)';
  if (r.includes('RT 49') || r.includes('RT49')) return name + ' (RT 49 SPE)';
  if (r.includes('VETTER')) return name + ' (Vetter)';
  if (r.includes('1 SPE') || r.includes('1SPE')) return name + ' (1SPE)';
  return name;
}

function fmtNum(n) {
  if (n == null) return '—';
  return n.toLocaleString('pt-BR');
}

function fmtArea(n) {
  if (n == null) return '—';
  return n.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' m²';
}

function totalUnits(p) {
  return (p.unid_habitacionais || 0) + (p.unid_comerciais || 0) + (p.unid_hospedagem || 0);
}

function tipoBadge(tipo) {
  const map = {
    'residencial_multifamiliar': ['Residencial', 'badge-residencial'],
    'hotel_comercial': ['Hotel/Comercial', 'badge-hotel'],
    'logistico_comercial': ['Logístico', 'badge-logistico'],
    'certidao_uso_solo': ['Certidão Uso Solo', 'badge-certidao'],
    'comercial': ['Comercial', 'badge-hotel'],
  };
  const [label, cls] = map[tipo] || ['Outro', ''];
  return `<span class="badge ${cls}">${label}</span>`;
}

// ----- Parse date string -----
const MONTHS = {
  'janeiro':0,'fevereiro':1,'março':2,'marco':2,'abril':3,'maio':4,'junho':5,
  'julho':6,'agosto':7,'setembro':8,'outubro':9,'novembro':10,'dezembro':11
};

function parseDate(s) {
  if (!s) return null;
  // "12 de setembro de 2024" or "30 NOVEMBRO 2024" (without "de")
  // Use [^\s\d]+ instead of \w+ to match accented chars (Ç in MARÇO, etc.)
  let m = s.match(/(\d{1,2})\s+de\s+([^\s\d]+)\s+de\s+(\d{4})/i);
  if (!m) m = s.match(/(\d{1,2})\s+([^\s\d]+)\s+(\d{4})/i);
  if (!m) return null;
  const month = MONTHS[m[2].toLowerCase()];
  if (month === undefined) return null;
  return new Date(parseInt(m[3]), month, parseInt(m[1]));
}

function fmtDate(s) {
  const d = parseDate(s);
  if (!d) return '—';
  return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function fmtDateShort(s) {
  const d = parseDate(s);
  if (!d) return '—';
  return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' });
}

// ----- Render Functions -----

function renderSummary() {
  const building = DATA.filter(p => p.categoria !== 'certidao_uso_solo');
  const withPav = building.filter(p => p.pavimentos > 0);
  const avgPav = withPav.length ? Math.round(withPav.reduce((s, p) => s + p.pavimentos, 0) / withPav.length) : 0;
  const stats = [
    { number: DATA.length, label: 'Projetos Protocolados desde 2024' },
    { number: avgPav, label: 'Núm. Médio de Pavimentos / Projeto' },
    { number: building.reduce((s, p) => s + (p.unid_habitacionais || 0), 0), label: 'Unid. Habitacionais' },
    { number: building.reduce((s, p) => s + (p.vagas_estacionamento || 0), 0), label: 'Vagas Estacion.' },
  ];
  const el = document.getElementById('summary');
  el.innerHTML = stats.map(s => `
    <div class="stat-card">
      <div class="number">${s.fmt ? s.fmt(s.number) : fmtNum(s.number)}</div>
      <div class="label">${s.label}</div>
    </div>
  `).join('');
}

// ----- Chart -----
let barChart = null;
const CHART_MODES = [
  { key: 'area_construida_m2', label: 'Área Construída (m²)' },
  { key: 'pavimentos', label: 'Pavimentos' },
  { key: 'unid_total', label: 'Total Unidades' },
  { key: 'vagas_estacionamento', label: 'Vagas' },
];
let currentMode = 'area_construida_m2';

function renderChartToggles() {
  const el = document.getElementById('chart-toggles');
  el.innerHTML = CHART_MODES.map(m =>
    `<button data-mode="${m.key}" class="${m.key === currentMode ? 'active' : ''}" onclick="setChartMode('${m.key}')">${m.label}</button>`
  ).join('');
}

function setChartMode(mode) {
  currentMode = mode;
  renderChartToggles();
  updateChart();
}

function updateChart() {
  const building = DATA.map(p => ({ ...p, unid_total: totalUnits(p) }))
    .sort((a, b) => (b[currentMode] || 0) - (a[currentMode] || 0));

  const labels = building.map(p => shortName(p));
  const values = building.map(p => p[currentMode] || 0);
  const colors = building.map(p => bairroColor(p.bairro));

  if (barChart) barChart.destroy();

  const modeLabel = CHART_MODES.find(m => m.key === currentMode)?.label || '';

  barChart = new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors.map(c => c + 'cc'),
        borderColor: colors,
        borderWidth: 1,
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `${modeLabel}: ${fmtNum(ctx.raw)}`
          }
        }
      },
      scales: {
        x: { grid: { color: '#f0f0f0' } },
        y: { ticks: { font: { size: 11 } } }
      }
    }
  });
}

// ----- Skyline -----
function skylineColor(pav, maxPav) {
  // Orange (#ea580c) → dark (#1a1a1a) gradient based on floor count
  const t = maxPav > 0 ? pav / maxPav : 0;
  const r = Math.round(234 - t * 208);  // 234 → 26
  const g = Math.round(88 - t * 62);    // 88 → 26
  const b = Math.round(12 - t * -14);   // 12 → 26
  return `rgb(${r},${g},${b})`;
}

function renderSkyline() {
  const all = [...DATA].sort((a, b) => (a.pavimentos || 0) - (b.pavimentos || 0));
  const maxPav = Math.max(...all.map(p => p.pavimentos || 0));
  const maxH = 240;

  const el = document.getElementById('skyline');
  el.innerHTML = all.map(p => {
    const pav = p.pavimentos || 0;
    const torres = p.torres || 1;
    const torreLabel = torres > 1 ? ` (${torres}t)` : '';

    if (pav === 0) {
      return `
        <div class="skyline-bar" style="height:30px; background:#e5e7eb; border:1px dashed #d1d5db;"
             title="${shortName(p)}: sem dados de pavimentos">
          <span class="floors" style="color:#9ca3af">—</span>
          <span class="name" style="position:absolute;bottom:-30px;color:#9ca3af">${shortName(p)}</span>
        </div>
      `;
    }

    const color = skylineColor(pav, maxPav);
    const h = Math.max(30, (pav / maxPav) * maxH);
    return `
      <div class="skyline-bar" style="height:${h}px; background:${color};"
           title="${shortName(p)}: ${pav} pav${torreLabel}">
        <span class="floors">${pav}</span>
        <span class="name" style="position:absolute;bottom:-30px;color:${color}">${shortName(p)}</span>
      </div>
    `;
  }).join('');
  el.style.paddingBottom = '40px';
}

// ----- Project Cards -----
function renderCards() {
  const bairroFilter = document.getElementById('filterBairro').value;
  const sortKey = document.getElementById('sortBy').value;

  let projects = DATA.map(p => ({ ...p, unid_total: totalUnits(p) }));
  if (bairroFilter) {
    projects = projects.filter(p => normalizeBairro(p.bairro) === bairroFilter);
  }
  projects.sort((a, b) => {
    if (sortKey === 'data_protocolo') {
      const da = parseDate(a.data_protocolo) || new Date(9999, 0);
      const db = parseDate(b.data_protocolo) || new Date(9999, 0);
      return da - db;
    }
    return (b[sortKey] || 0) - (a[sortKey] || 0);
  });

  const grid = document.getElementById('cards-grid');
  grid.innerHTML = projects.map(p => {
    const hasApproval = p.parecer_num != null;
    const statusTag = hasApproval
      ? `<span class="tag tag-approved">Aprovado</span>`
      : `<span class="tag tag-pending">Em análise</span>`;
    const voteTag = p.resultado_voto
      ? `<span class="tag">${p.resultado_voto}</span>`
      : '';

    return `
      <div class="project-card">
        <div class="card-header">
          <div class="card-title">${buildingName(p)}${p.url_eiv ? ` <a href="${p.url_eiv}" target="_blank" title="Baixar EIV/RIV (PDF)" style="color:var(--accent);text-decoration:none;font-size:0.8rem;opacity:0.7">&#x2197;&#xFE0E;</a>` : ''}</div>
          ${tipoBadge(p.tipo)}
        </div>
        <div class="card-company" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${p.requerente || ''}">${(p.requerente || '—').replace('SOCIEDADE DE PROPÓSITO ESPECÍFICO ', '')}</div>
        <div class="card-company" style="border-left:3px solid var(--accent);padding-left:8px">${p.endereco || ''}${p.bairro ? ` — ${normalizeBairro(p.bairro)}` : ''}</div>
        <div class="card-stats">
          ${p.pavimentos ? `<div class="card-stat"><strong>${p.pavimentos}</strong> pavimentos</div>` : ''}
          ${p.torres ? `<div class="card-stat"><strong>${p.torres}</strong> torre${p.torres > 1 ? 's' : ''}</div>` : ''}
          ${p.area_construida_m2 ? `<div class="card-stat"><strong>${fmtArea(p.area_construida_m2)}</strong></div>` : ''}
          ${p.unid_habitacionais ? `<div class="card-stat"><strong>${fmtNum(p.unid_habitacionais)}</strong> unid. hab.</div>` : ''}
          ${p.unid_hospedagem ? `<div class="card-stat"><strong>${fmtNum(p.unid_hospedagem)}</strong> hospedagem</div>` : ''}
          ${p.unid_comerciais ? `<div class="card-stat"><strong>${fmtNum(p.unid_comerciais)}</strong> comerciais</div>` : ''}
          ${p.vagas_estacionamento ? `<div class="card-stat"><strong>${fmtNum(p.vagas_estacionamento)}</strong> vagas</div>` : ''}
          ${p.area_terreno_m2 ? `<div class="card-stat"><strong>${fmtArea(p.area_terreno_m2)}</strong> terreno</div>` : ''}
        </div>
        <div class="card-dates" style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:10px;padding-top:8px;border-top:1px solid var(--border)">
          ${p.data_protocolo ? `<div>Requerimento: ${fmtDate(p.data_protocolo)}</div>` : ''}
          ${p.data_audiencia_publica ? `<div>Audiência Pública: ${fmtDate(p.data_audiencia_publica)}</div>` : ''}
          ${p.data_reuniao ? `<div>Plenária: ${fmtDate(p.data_reuniao)}</div>` : ''}
          ${p.data_assinatura ? `<div>Deliberação: ${fmtDate(p.data_assinatura)}</div>` : ''}
        </div>
        <div class="card-tags">
          ${statusTag}
          ${voteTag}
        </div>
      </div>
    `;
  }).join('');
}

function initFilters() {
  const bairros = [...new Set(DATA.map(p => normalizeBairro(p.bairro)))].sort();
  const sel = document.getElementById('filterBairro');
  bairros.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b;
    opt.textContent = b;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', renderCards);
  document.getElementById('sortBy').addEventListener('change', renderCards);
}

// ----- Timeline -----
function renderTimeline() {
  const projects = DATA.filter(p =>
    p.data_protocolo || p.data_audiencia_publica || p.data_reuniao || p.data_assinatura
  );
  if (!projects.length) {
    document.getElementById('timeline').innerHTML = '<p style="padding:16px;color:#888">Sem datas disponíveis.</p>';
    return;
  }

  // Find date range — pad to nearest Jan 1 boundaries so year lines always show
  let allDates = [];
  projects.forEach(p => {
    [p.data_protocolo, p.data_audiencia_publica, p.data_reuniao, p.data_assinatura].forEach(d => {
      const parsed = parseDate(d);
      if (parsed) allDates.push(parsed);
    });
  });

  const dataMin = new Date(Math.min(...allDates));
  const dataMax = new Date(Math.max(...allDates));
  // Pad: start 1 month before earliest date, end at Feb 1 of year after latest
  const minDate = new Date(dataMin.getFullYear(), dataMin.getMonth() - 1, 1);
  const maxDate = new Date(dataMax.getFullYear() + 1, 1, 1);
  const range = maxDate - minDate || 1;

  function datePos(s) {
    const d = parseDate(s);
    if (!d) return null;
    return ((d - minDate) / range) * 100;
  }

  // Sort by protocol date (latest first)
  projects.sort((a, b) => {
    const da = parseDate(a.data_protocolo) || parseDate(a.data_audiencia_publica) || new Date(0);
    const db = parseDate(b.data_protocolo) || parseDate(b.data_audiencia_publica) || new Date(0);
    return db - da;
  });

  // Year markers
  const yearMarkers = [];
  for (let y = minDate.getFullYear(); y <= maxDate.getFullYear(); y++) {
    const jan1 = new Date(y, 0, 1);
    const pos = ((jan1 - minDate) / range) * 100;
    if (pos >= 0 && pos <= 100) {
      yearMarkers.push({ year: y, pos });
    }
  }

  const el = document.getElementById('timeline');

  // Build labels column (fixed) and tracks column (scrollable)
  const labelsHtml = [];
  const tracksHtml = [];

  // Year header
  labelsHtml.push(`<div class="timeline-label-row" style="border-bottom:none;height:22px"></div>`);
  tracksHtml.push(`
    <div class="timeline-track-row" style="border-bottom:none;height:22px">
      <div class="timeline-track" style="height:18px">
        ${yearMarkers.map(m => `<span style="position:absolute;left:${m.pos}%;transform:translateX(-50%);font-size:0.72rem;font-weight:700;color:#9ca3af">${m.year}</span>`).join('')}
      </div>
    </div>
  `);

  projects.forEach(p => {
    const proto = datePos(p.data_protocolo);
    const aud = datePos(p.data_audiencia_publica);
    const reu = datePos(p.data_reuniao);
    const par = datePos(p.data_assinatura);

    const dots = [];
    if (proto !== null) dots.push(`<div class="timeline-dot protocolo" style="left:${proto}%" title="Requerimento: ${fmtDate(p.data_protocolo)}"><span class="dot-label">${fmtDateShort(p.data_protocolo)}</span></div>`);
    if (aud !== null) dots.push(`<div class="timeline-dot audiencia" style="left:${aud}%" title="Audiência: ${fmtDate(p.data_audiencia_publica)}"><span class="dot-label">${fmtDateShort(p.data_audiencia_publica)}</span></div>`);
    if (reu !== null) dots.push(`<div class="timeline-dot reuniao" style="left:${reu}%" title="Plenária: ${fmtDate(p.data_reuniao)}"><span class="dot-label">${fmtDateShort(p.data_reuniao)}</span></div>`);
    if (par !== null) dots.push(`<div class="timeline-dot parecer" style="left:${par}%" title="Deliberação: ${fmtDate(p.data_assinatura)}"><span class="dot-label">${fmtDateShort(p.data_assinatura)}</span></div>`);

    const positions = [proto, aud, reu, par].filter(x => x !== null);
    const lineStart = Math.min(...positions);
    const lineEnd = Math.max(...positions);

    const eivLink = p.url_eiv
      ? `<a href="${p.url_eiv}" target="_blank" title="Baixar EIV/RIV (PDF)" style="margin-left:5px;color:var(--accent);text-decoration:none;font-size:0.72rem;vertical-align:middle;opacity:0.7" class="eiv-link">&#x2197;&#xFE0E;</a>`
      : '';

    labelsHtml.push(`<div class="timeline-label-row" title="${shortName(p)}">${shortName(p)}${eivLink}</div>`);
    tracksHtml.push(`
      <div class="timeline-track-row">
        <div class="timeline-track">
          ${yearMarkers.map(m => `<div style="position:absolute;left:${m.pos}%;top:0;bottom:0;width:1px;background:#e5e7eb;z-index:0"></div>`).join('')}
          <div class="timeline-line" style="left:${lineStart}%;width:${lineEnd - lineStart}%"></div>
          ${dots.join('')}
        </div>
      </div>
    `);
  });

  el.innerHTML = `
    <div class="timeline-labels">${labelsHtml.join('')}</div>
    <div class="timeline-tracks-wrapper"><div class="timeline-tracks">${tracksHtml.join('')}</div></div>
  `;

  // Click/tap anywhere in tracks toggles all dots expanded/collapsed
  const tracksEl = el.querySelector('.timeline-tracks');
  el.querySelector('.timeline-tracks-wrapper').addEventListener('click', () => {
    const dots = el.querySelectorAll('.timeline-dot');
    const anyExpanded = el.querySelector('.timeline-dot.expanded');
    const expanding = !anyExpanded;
    dots.forEach(d => d.classList.toggle('expanded', expanding));
    tracksEl.classList.toggle('expanded', expanding);
  });
}

// ----- Export Section as PNG -----
async function exportSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (!section) return;

  // Hide export button during capture
  const exportBtn = section.querySelector('.section-export');
  if (exportBtn) exportBtn.style.display = 'none';

  // Temporarily add attribution footer
  const footer = document.createElement('div');
  footer.style.cssText = 'text-align:center;padding:12px 0 4px;font-size:0.72rem;color:#9ca3af;border-top:1px solid #e5e7eb;margin-top:12px;';
  footer.textContent = `Fonte: Portal CONCIDADE — Prefeitura de Penha/SC | Gerado em ${new Date().toLocaleDateString('pt-BR')}`;
  section.appendChild(footer);

  const canvas = await html2canvas(section, {
    scale: 2,
    useCORS: true,
    backgroundColor: '#f5f5f5',
    logging: false,
  });

  section.removeChild(footer);
  if (exportBtn) exportBtn.style.display = '';

  const link = document.createElement('a');
  link.download = sectionId + '.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
}

// ----- Init -----
async function init() {
  document.getElementById('gen-date').textContent = new Date().toLocaleDateString('pt-BR');

  try {
    const resp = await fetch('data.json');
    DATA = await resp.json();
  } catch (e) {
    // Fallback: try inline
    console.error('Failed to load data.json:', e);
    document.getElementById('summary').innerHTML = '<p>Erro ao carregar dados. Certifique-se de que data.json existe no mesmo diretório.</p>';
    return;
  }

  renderSummary();
  renderChartToggles();
  updateChart();
  renderSkyline();
  initFilters();
  renderCards();
  renderTimeline();
}

init();
</script>
</body>
</html>
